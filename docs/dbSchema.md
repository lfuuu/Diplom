# Структура базы данных

![Структура БД](db/db_schema.png)

Схема БД сгенерирована автоматически с использованием инструмента [ERD Tool](https://www.pgadmin.org/docs/pgadmin4/development/erd_tool.html) PgAdmin4.0  на основании sql схемы сущностей проекта.

## Файл генерации БД

- [init.sql](/install/cont_postgresql/init.sql)

## Описание схем

Таблицы БД сгрупиррованы по различным схема

- auth  - таблицы описывающие сетевые настройки узла связи
- billing - таблицы описывающие коммерческие настройки узла связи
- calls - таблицы фиксирующие факты прохождения и тарификации звонков через узел связи

## Описание таблица БД

<table>
<tr>
<th>Схема</th>
<th>Таблица</th>
<th>Связи</th>
<th>Описание</th>
</tr>

<tr>
<td>billing</td>
<td>clients</td>
<td>-</td>
<td>Содержит записи описывающие абонентов и операторов с которыми взаимодействует Узел Связи. также есть информация о балансе на начала периода и о факте блокировки.</td>
</tr>


<tr>
<td>billing</td>
<td>pricelist</td>
<td>-</td>
<td>Содержит заголовки прайслистов, по которым происходит тарафикация вызовов.</td>
</tr>


<tr>
<td>billing</td>
<td>pricelist_item</td>
<td>pricelist_id -> billing.pricelist.id</td>
<td>Содержит наполнение прайслистов, стоимость минуты в зависимости от префикса вызываемого номера. Например: код 8926 -> 1.26руб, код 8495 -> 1.5руб. </td>
</tr>


<tr>
<td>billing</td>
<td>service_number</td>
<td>client_id -> billing.client.id</td>
<td>Содержит информацию о принадлежности номеров абонентам узла. Услуга номер имеет время начала действия и время окончания. в один момент номер может принадлежать только одному абоненту</td>
</tr>

<tr>
<td>billing</td>
<td>packet</td>
<td>client_id -> billing.client.id</td>
<td>Содержит информацию о принадлежности номеров абонентам узла. Услуга номер имеет время начала действия и время окончания. в один момент номер может принадлежать только одному абоненту</td>
</tr>

<tr>
<td>billing</td>
<td>service_trunk</td>
<td>client_id -> billing.client.id
<br>trunk_id -> auth.trunk.id
</td>
<td>Содержит информацию о принадлежности транков абонентам узла. Услуга номер имеет время начала действия и время окончания. Содержит настройки разрешающие Узлу связи принимать и отправлять звонки в этот транк</td>
</tr>

<tr>
<td>auth</td>
<td>client_id -> billing.client.id</td>
<td>
service_trunk_id -> billing.service_trunk.id<br>
service_number_id -> billing.service_number.id<br>
pricelist_id -> billing.pricelist.id
</td>
<td>Содержит привязку действующих прайслистов к услугам. прайслит может приненяться для оригинационных и терминационных плеч. имеет срок действия. прайслистов может быть много. выбирается с наименьшей ценой.</td>
</tr>

<tr>
<td>auth</td>
<td>trunk</td>
<td>-</td>
<td>Содержит информацию о транках подключенных к Узлу Связи. Транк может быть розничным (подключенным к ВАТС), либо операторским (подключенный к внешнему оператору Свзязи).</td>
</tr>

<tr>
<td>calls</td>
<td>cdr</td>
<td>-</td>
<td>Содержит информацию о фактах прохождания звонка через Узел Связи. номера, транки, длительность, причина завершения вызова</td>
</tr>

<tr>
<td>calls</td>
<td>raw</td>
<td> 
cdr_id -> calls.cdr.id<br>
trunk_id -> auth.trunk.id<br>
client_id -> billing.clients.id<br>
service_trunk_id -> billing.service_trunk.id<br>
service_number_id -> billing.service_number.id<br>
pricelist_id -> billing.pricelist.id
</td>
<td>Содержит информацию о тарификации вызовов прошедших через Узел Связи.
Каждый вызов описывает оригнационным и терминационным плечом. Для каждого плеча вычисляется
услуга номер или транка, фиксирует номера, длительность, расчитывается цена и стоимость плеча.
</td>
</tr>


</table>


